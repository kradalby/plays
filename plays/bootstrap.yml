---
- name: Setup base configuration
  hosts: all

  pre_tasks:
    - name: Fix Ubuntu 20.04 vCenter - check for issue.original
      stat:
        path: /etc/issue.original
      register: issue

    - name: Fix Ubuntu 20.04 vCenter - restore original
      command: mv /etc/issue.original /etc/issue
      when: issue.stat.exists

    - name: Fix Ubuntu 20.04 vCenter - ensure backup is gone
      file:
        path: /etc/issue.original
        state: absent


    - name: Upgrade packages
      apt:
        upgrade: true
        update_cache: true

    - name: Install packages
      apt:
        update_cache: true
        pkg:
          - mosh
          - tmux
          - socat
          - tcpdump
        state: latest

  roles:
    - { role: repo, when: skip_repo is not defined }
    - dotfiles
    - apticron
    - { role: postfix, when: skip_postfix is not defined }
    - snmpd
    - {
        role: prometheus-node-exporter,
        when: skip_node_exporter is not defined,
      }
