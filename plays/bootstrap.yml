---
- name: Setup base configuration
  hosts: ubuntu

  pre_tasks:
    - name: Upgrade packages
      apt:
        upgrade: yes
        update_cache: yes

    - name: Install packages
      apt:
        update_cache: yes
        pkg:
          - iputils-ping
          - mosh
          - tmux
          - socat
          - tcpdump
          - silversearcher-ag
          - iputils-ping
          - htop
          - iotop
          - lsof
          - unzip
          - bzip2
          - xz-utils
          - ncdu
        state: latest

    - name: Remove packages
      apt:
        pkg:
          - aide
        state: absent

  roles:
    - role: roles/hostname
    - role: roles/repo
      when: skip_repo is undefined or not skip_repo
    - role: roles/datetime
    - role: roles/locale
    - role: roles/dotfiles
    - role: roles/apticron
    - role: roles/rclone
    - role: roles/restic
    # - role: roles/snmpd

    - role: roles/mount_devices
      when: mounts is defined and mounts|length > 0
    - role: roles/restic_backup_job
      when: restic_backup_job is defined and restic_backup_job
    - role: roles/ubuntu_no_snap
      when: snap is undefined or not snap
    - role: roles/wireguard
      when: wireguard is defined and wireguard
    - role: roles/postfix
      when: skip_postfix is not defined
    - role: roles/caddy-server
      when: caddy is defined and caddy
    - role: roles/ubuntu-swift
      when: swift is defined and swift
    - role: roles/nfs-export
      when: nfs_exports is defined and nfs_exports|length > 0
    - role: roles/prometheus-node-exporter
      when: node_exporter is undefined or node_exporter
    - role: roles/ubuntu_terraform
      when: terraform is defined and terraform
    - role: roles/blackbox_exporter
      when: blackbox_exporter is defined and blackbox_exporter
